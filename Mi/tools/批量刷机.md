安卓设备批量刷机脚本，针对 O1（xuanyuan）设备的代码

```sh
#!/bin/bash

# 获取所有 ADB 设备
adb_devices=$(adb devices | awk 'NR>1 {print $1}')

# 遍历所有设备，确保它们进入 fastboot 模式
for device in $adb_devices; do
    mode=$(adb -s "$device" shell getprop ro.bootmode 2>/dev/null | tr -d '\r')
    if [ "$mode" != "fastboot" ]; then
        echo "Rebooting $device to fastboot mode..."
        adb -s "$device" reboot bootloader
        
        # 轮询检测设备是否进入 fastboot 模式，最多等待 30 秒
        for i in {1..30}; do
            sleep 1
            fastboot_devices=$(fastboot devices | awk '{print $1}')
            if echo "$fastboot_devices" | grep -q "$device"; then
                echo "Device $device entered fastboot mode."
                break
            fi
        done
        
        # 如果 30 秒后仍未进入 fastboot 模式，则跳过
        if ! echo "$fastboot_devices" | grep -q "$device"; then
            echo "Device $device failed to enter fastboot mode, skipping..."
            continue
        fi
    fi

done

# 获取所有处于 fastboot 模式的设备
fastboot_devices=$(fastboot devices | awk '{print $1}')

# 检查是否有设备连接
if [ -z "$fastboot_devices" ]; then
    echo "No devices found in fastboot mode. Please connect devices and try again."
    exit 1
fi

# 记录刷机日志
log_file="flash_log_$(date +%Y%m%d_%H%M%S).txt"
echo "Starting batch flashing..." | tee -a "$log_file"

# 并发执行刷机，最多支持 5 台设备同时执行
max_parallel=5
sem=$(which parallel 2>/dev/null)
if [ -z "$sem" ]; then
    echo "GNU parallel is required for concurrent flashing. Attempting to install..."
    if command -v apt &>/dev/null; then
        sudo apt update && sudo apt install parallel -y
    elif command -v yum &>/dev/null; then
        sudo yum install epel-release -y && sudo yum install parallel -y
    elif command -v brew &>/dev/null; then
        brew install parallel
    else
        echo "Could not install GNU parallel. Please install it manually."
        exit 1
    fi
fi

echo "$fastboot_devices" | tr ' ' '\n' | parallel -j $max_parallel --lb "
    device={} 
    echo 'Flashing device: {}' | tee -a '$log_file'
    
    fastboot -s \"$device\" getvar product 2>&1 | grep -E \"^product: *xuanyuan\"
    if [ $? -ne 0 ]; then 
        echo "Device $device mismatching image and device" | tee -a "$log_file"
        exit 1
    fi
    
    if [ -e "$(dirname $0)/images/anti_version.txt" ]; then
        CURRENT_ANTI_VER=$(cat "$(dirname $0)/images/anti_version.txt")
    fi
    if [ -z "$CURRENT_ANTI_VER" ]; then CURRENT_ANTI_VER=0; fi
    ver=$(fastboot -s "$device" getvar anti 2>&1 | grep -oP "anti: \K[0-9]+")
    if [ -z "$ver" ]; then ver=0; fi
    if [ "$ver" -gt "$CURRENT_ANTI_VER" ]; then
        echo "Device $device anti-rollback version too high, skipping..." | tee -a "$log_file"
        exit 1
    fi
    
    echo "Flashing $device..." | tee -a "$log_file"
    fastboot -s "$device" flash bootloader bootloader.img
    fastboot -s "$device" reboot-bootloader
    fastboot -s "$device" flash radio radio.img
    fastboot -s "$device" flash system system.img
    fastboot -s "$device" flash boot boot.img
    fastboot -s "$device" flash recovery recovery.img
    fastboot -s "$device" flash userdata userdata.img
    fastboot -s "$device" flash cache cache.img
    fastboot -s "$device" reboot
    
    echo "Device $device flashed successfully!" | tee -a "$log_file"
"

echo "Batch flashing completed." | tee -a "$log_file"

```

