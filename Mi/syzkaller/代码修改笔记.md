# vm

## adb

路径：syzkaller/vm/adb/adb.go

waitForBootCompletion()

```go
func (inst *instance) waitForBootCompletion() {
	// ADB connects to a phone and starts syz-executor while the phone is still booting.
	// This enables syzkaller to create a race condition which in certain cases doesn't
	// allow the phone to finalize initialization.
	// To determine whether a system has booted and started all system processes and
	// services we wait for a process named 'com.android.systemui' to start. It's possible
	// that in the future a new devices which doesn't have 'systemui' process will be fuzzed
	// with adb, in this case this code should be modified with a new process name to search for.
	log.Logf(2, "waiting for boot completion")

	sleepTime := 5
	sleepDuration := time.Duration(sleepTime) * time.Second
	maxWaitTime := 60 * 3 // 3 minutes to wait until boot completion
	maxRetries := maxWaitTime / sleepTime
	i := 0
	for ; i < maxRetries; i++ {
		time.Sleep(sleepDuration)
		if out, err := inst.adb("shell", "pgrep systemui | wc -l"); err == nil {
			count := parseAdbOutToInt(out)
			if count != 0 {
        #############新增代码：提高充电功率##################
				// 尝试获取 root 权限
				if _, err := inst.adb("root"); err != nil {
					log.Logf(0, "failed to gain root access: %v", err)
				} else {
					log.Logf(0, "root access granted")
				}
				// 设置充电限制
				if _, err := inst.adb("shell", "echo mtbf buck 1500 > /sys/class/xm_power/charger/charge_interface/iin_limit"); err != nil {
					log.Logf(0, "failed to set charge limit: %v", err)
				} else {
					log.Logf(0, "charge limit set successfully")
				}
        ##################################################

				log.Logf(0, "boot completed")
				break
			}
		} else {
			log.Logf(0, "failed to execute command 'pgrep systemui | wc -l', %v", err)
			break
		}
	}
	if i == maxRetries {
		log.Logf(0, "failed to determine boot completion, can't find 'com.android.systemui' process")
	}
}
```

```go
#############新增代码：提高充电功率##################
// 尝试获取 root 权限
if _, err := inst.adb("root"); err != nil {
  log.Logf(0, "failed to gain root access: %v", err)
} else {
  log.Logf(0, "root access granted")
}
// 设置充电限制
if _, err := inst.adb("shell", "echo mtbf buck 1500 > /sys/class/xm_power/charger/charge_interface/iin_limit"); err != nil {
  log.Logf(0, "failed to set charge limit: %v", err)
} else {
  log.Logf(0, "charge limit set successfully")
}
##################################################
```

